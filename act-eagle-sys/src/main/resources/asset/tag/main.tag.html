<main>
    <welcome class="{invisible: view !== 'welcome'}"></welcome>
    <viewbox class="{invisible: view !== 'viewbox'}"></viewbox>
    <style>
        .invisible {display: none}
    </style>

    <script>
        var tag = this;
        tag.view = 'welcome';
        tag.url = "";
        tag.lastEvent = false;

        eventBus.on('open', function(data) {
//            console.log("param.url=" + data.uri);
//            console.log("param.view=" + data.view);
            tag.view = data.view; // 设置要显示的区域
            loadPage(data.uri, data.params, "", null); //真正的加载页面
            tag.lastEvent = {
                id: 'open',
                param:   data.params
            }
            tag.update();
        })
        eventBus.on('resend-last-event', function() {
            if (!tag.lastEvent) return    ;
            var lastEvent = tag.lastEvent  ;
            tag.lastEvent = false;
            eventBus.trigger(lastEvent.id, lastEvent.param);
        })
        /**
         * 功能：页面HTML加载
         * @url 页面url
         * @data 搜索参数序列化对象
         * @$pageListPanel 页面HTML容器，默认为$("#htmlbox")
         */
        var loadPage = function(url,params,$pageListPanel,callback) {
            if (!url || url == "") return;
            ajaxHTML(url,params,function (html) {
                var $panel = $pageListPanel || $("#htmlbox");
                $panel.html(html);
                if(typeof callback == "function"){
                    callback();
                }
            });
        }

        var ajaxHTML= function(url,params,callback) {
            if (!url || url == "") return;
            var _url = url;
            _url += url.indexOf("?") == -1 ? "?" : "&";
            _url += "timer=" + new Date().getTime();
            console.log("数据加载中...请稍候...", "loading");
//            $.jBox.tip("数据加载中...请稍候...", "loading");
            $.ajax({
                url: url,
                data: params,
                dataType: "html",
                success: function (html) {
                    if (typeof callback == "function") {
                        callback(html);
                    }
//                    $.jBox.closeTip();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
//                    $.jBox.closeTip();
//                    $.jBox.error('<p style="color:red;padding-top:5px;font-size:14px;">程序异常，请联系管理员！</p>',"操作提示！");
                    console.log("程序异常，请联系管理员");
                }
            });
        }
    </script>
</main>